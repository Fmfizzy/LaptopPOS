<!-- # app/templates/view_all.html -->
{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="repairs-tab" data-bs-toggle="tab" data-bs-target="#repairs" type="button">
                    Repair Jobs
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="invoices-tab" data-bs-toggle="tab" data-bs-target="#invoices" type="button">
                    Invoices
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="quotations-tab" data-bs-toggle="tab" data-bs-target="#quotations" type="button">
                    Quotations
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="customers-tab" data-bs-toggle="tab" data-bs-target="#customers" type="button">
                    Customers
                </button>
            </li>
        </ul>

        <div class="tab-content mt-3" id="myTabContent">
            <!-- Repairs Tab -->
            <div class="tab-pane fade show active" id="repairs">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>Repair Jobs</h4>
                    <a href="{{ url_for('new_repair') }}" class="btn btn-primary">New Repair</a>
                </div>
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Job Number</th>
                            <th>Customer</th>
                            <th>Model</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for repair in repairs %}
                        <tr class="{{ status_colors[repair.status] }}" id="repair-row-{{ repair.id }}">
                            <td>{{ repair.job_number }}</td>
                            <td>{{ repair.customer.name }}</td>
                            <td>{{ repair.laptop_model }}</td>
                            <td>
                                <select class="form-select form-select-sm" data-repair-id="{{ repair.id }}">
                                    {% for status in repair_statuses %}
                                    <option value="{{ status }}" {% if status == repair.status %}selected{% endif %}>
                                        {{ status }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>{{ repair.created_date.strftime('%Y-%m-%d') }}</td>
                            <td class="action-buttons">
                                <a href="{{ url_for('view_repair', repair_id=repair.id) }}" class="btn btn-sm btn-info">View/Edit</a>
                                {% if repair.status == 'Repaired' %}
                                <a href="{{ url_for('create_invoice', repair_id=repair.id) }}" class="btn btn-sm btn-success">Create Invoice</a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Invoices Tab -->
            <div class="tab-pane fade" id="invoices">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>Invoices</h4>
                </div>
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Invoice #</th>
                            <th>Job Number</th>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for invoice in invoices %}
                        <tr class="{% if invoice.status == 'paid' %}table-success{% else %}table-warning{% endif %}">
                            <td>INV-{{ invoice.id }}</td>
                            <td>{{ invoice.repair_job.job_number }}</td>
                            <td>{{ invoice.repair_job.customer.name }}</td>
                            <td>{{ invoice.invoice_date.strftime('%Y-%m-%d') }}</td>
                            <td>${{ "%.2f"|format(invoice.total_amount|float) }}</td>
                            <td>{{ invoice.status|title }}</td>
                            <td>
                                <a href="{{ url_for('view_invoice', invoice_id=invoice.id) }}" class="btn btn-sm btn-info">View</a>
                                {% if invoice.status == 'pending' %}
                                <button class="btn btn-sm btn-success mark-paid-btn" data-invoice-id="{{ invoice.id }}">Mark Paid</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Quotations Tab -->
            <div class="tab-pane fade" id="quotations">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>Quotations</h4>
                    <a href="#" class="btn btn-primary">New Quotation</a>
                </div>
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Quotation #</th>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for quotation in quotations %}
                        <tr class="{% if quotation.status == 'paid' %}table-success{% else %}table-warning{% endif %}">
                            <td>{{ quotation.quotation_number }}</td>
                            <td>{{ quotation.customer.name }}</td>
                            <td>{{ quotation.quotation_date.strftime('%Y-%m-%d') }}</td>
                            <td>${{ "%.2f"|format(quotation.total_amount|float) }}</td>
                            <td>{{ quotation.status|title }}</td>
                            <td>
                                <a href="#" class="btn btn-sm btn-info">View</a>
                                {% if quotation.status == 'open' %}
                                <button class="btn btn-sm btn-success">Convert to Invoice</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Customers Tab -->
            <div class="tab-pane fade" id="customers">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>Customers</h4>
                    <a href="#" class="btn btn-primary">New Customer</a>
                </div>
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Contact</th>
                            <th>Email</th>
                            <th>Jobs</th>
                            <th>Created Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for customer in customers %}
                        <tr>
                            <td>{{ customer.name }}</td>
                            <td>{{ customer.contact_number }}</td>
                            <td>{{ customer.email }}</td>
                            <td>{{ customer.repair_jobs|length }}</td>
                            <td>{{ customer.created_date.strftime('%Y-%m-%d') }}</td>
                            <td>
                                <a href="#" class="btn btn-sm btn-info">View</a>
                                <a href="#" class="btn btn-sm btn-primary">Edit</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Repair status update handling
    const statusSelects = document.querySelectorAll('.form-select');
    
    statusSelects.forEach(select => {
        select.addEventListener('change', function() {
            const repairId = this.dataset.repairId;
            const newStatus = this.value;
            const row = this.closest('tr');
            
            fetch(`/repair/${repairId}/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `status=${newStatus}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update row color
                    row.className = data.colorClass;
                    
                    // Update invoice button visibility
                    const actionCell = row.querySelector('.action-buttons');
                    const existingInvoiceButton = actionCell.querySelector('.btn-success');
                    
                    if (newStatus === 'Repaired') {
                        if (!existingInvoiceButton) {
                            actionCell.insertAdjacentHTML('beforeend', 
                                ` <a href="/repair/${repairId}/invoice" class="btn btn-sm btn-success">Create Invoice</a>`
                            );
                        }
                    } else if (existingInvoiceButton) {
                        existingInvoiceButton.remove();
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update status');
                location.reload();
            });
        });
    });

    // Preserve active tab after page reload
    const hash = window.location.hash;
    if (hash) {
        const tab = document.querySelector(`[data-bs-target="${hash}"]`);
        if (tab) {
            new bootstrap.Tab(tab).show();
        }
    }
});
</script>
{% endblock %}
{% endblock %}